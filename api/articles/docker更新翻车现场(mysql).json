{"title":"docker更新翻车现场(mysql)","uid":"f8f3e6fc8bfd30a95b31c3b03dfa61df","slug":"docker更新翻车现场(mysql)","date":"2023-03-29T14:50:48.000Z","updated":"2023-03-30T05:52:46.299Z","comments":true,"path":"api/articles/docker更新翻车现场(mysql).json","keywords":null,"cover":"https://picsum.photos/432/285?random=2","content":"<h1 id=\"docker更新翻车现场-mysql\"><a href=\"#docker更新翻车现场-mysql\" class=\"headerlink\" title=\"docker更新翻车现场(mysql)\"></a>docker更新翻车现场(mysql)</h1><p>由于docker自动拉取最新mysql镜像导致mysql容器无法启动，当日志中出现如下代码：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Cannot boot server version 80031 on data directory built by version 80032. Downgrade is not supported</code></pre>\n\n<p>翻译过来就是：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">无法在80032版本构建的数据目录上引导服务器80031版本。不支持降级</code></pre>\n\n<p>那么这就是个悲伤的故事了,看完这个文章或许对你有帮助</p>\n<h2 id=\"创建新容器，恢复数据\"><a href=\"#创建新容器，恢复数据\" class=\"headerlink\" title=\"创建新容器，恢复数据\"></a>创建新容器，恢复数据</h2><p>创建新容器，使用旧的镜像，然后相关的环境变量和配置项都设置好，通过navicat连接保持畅通。</p>\n<h2 id=\"通过ibd文件恢复数据\"><a href=\"#通过ibd文件恢复数据\" class=\"headerlink\" title=\"通过ibd文件恢复数据\"></a>通过ibd文件恢复数据</h2><p>1、首先创建一张表，表结构跟原表结构相同</p>\n<p>2、查询所有表名（为了批量操作）</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">show tables;</code></pre>\n\n<p>3、删除表空间</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">ALTER TABLE users DISCARD TABLESPACE;\t\t</code></pre>\n\n<p>可能会遇到</p>\n<pre class=\"line-numbers language-mysql\" data-language=\"mysql\"><code class=\"language-mysql\">Cannot delete or update a parent row: a foreign key constraint fails</code></pre>\n\n<p>原因：这个报错的原因是因为我们在执行sql的时候会进行外键约束检查，如果你想删除这个表的话，可以暂时将其关闭，删除完了之后在开启，如下：</p>\n<pre class=\"line-numbers language-mysql\" data-language=\"mysql\"><code class=\"language-mysql\">SET foreign_key_checks &#x3D; 0;  &#x2F;&#x2F; 关闭外键约束检查\n\nDROP TABLE  lms_course_quiz;  &#x2F;&#x2F; 删表\n\nSET foreign_key_checks &#x3D; 1; &#x2F;&#x2F; 再开启外键约束检查\n</code></pre>\n\n<p>4、将待恢复的.ibd文件直接复制到现.ibd文件目录中</p>\n<p>5、恢复表空间</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">ALTER TABLE users IMPORT TABLESPACE;</code></pre>\n\n<h2 id=\"通过MYD-MYI-SDI数据库恢复\"><a href=\"#通过MYD-MYI-SDI数据库恢复\" class=\"headerlink\" title=\"通过MYD MYI SDI数据库恢复\"></a>通过MYD MYI SDI数据库恢复</h2><table>\n<thead>\n<tr>\n<th align=\"left\">文件</th>\n<th align=\"left\">说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">XXX.sdi</td>\n<td align=\"left\">表结构文件</td>\n</tr>\n<tr>\n<td align=\"left\">XXX.MYD</td>\n<td align=\"left\">数据文件</td>\n</tr>\n<tr>\n<td align=\"left\">XXX.MYI</td>\n<td align=\"left\">索引文件</td>\n</tr>\n</tbody></table>\n<ul>\n<li><p>前后对比，我们发现只有<code>.sdi</code>文件名不一样。先把旧表数据<code>.MYD</code> <code>.MYI</code>替换新表<code>.MYD</code> <code>.MYI</code>，然后将新表的<code>.sdi</code>给旧表重命名后替换！</p>\n</li>\n<li><p>重启数据库，就可以看到数据已恢复！</p>\n</li>\n</ul>\n<h2 id=\"血与泪的教训\"><a href=\"#血与泪的教训\" class=\"headerlink\" title=\"血与泪的教训\"></a>血与泪的教训</h2><p>1、使用docker容器的时候，一定要指定镜像image的版本号，不能使用latest，防止因为重启自动升级版本导致无法启动。</p>\n<p>2、数据库一定要做定时备份，平时用不到，用到了就能发挥大作用。即使是测试环境也要做，当然看情况。</p>\n<h2 id=\"补充：Innodb与MyISAM存储文件的区别\"><a href=\"#补充：Innodb与MyISAM存储文件的区别\" class=\"headerlink\" title=\"补充：Innodb与MyISAM存储文件的区别\"></a>补充：Innodb与MyISAM存储文件的区别</h2><p>Innodb存储文件分为：.frm，.idb<br>    .frm：存储表定义<br>    .ibd：存储数据和索引<br>MyISAM存储文件分为：.frm，.myd，.myi<br>    .frm：存储表定义<br>    .myd：存储数据<br>    .myi：存储索引</p>\n","text":"docker更新翻车现场(mysql)由于docker自动拉取最新mysql镜像导致mysql容器无法启动，当日志中出现如下代码： Cannot boot server version 80031 on data directory built by version 80032....","link":"","photos":[],"count_time":{"symbolsCount":"1.2k","symbolsTime":"1 mins."},"categories":[{"name":"docker","slug":"docker","count":4,"path":"api/categories/docker.json"}],"tags":[{"name":"docker","slug":"docker","count":4,"path":"api/tags/docker.json"},{"name":"mysql","slug":"mysql","count":1,"path":"api/tags/mysql.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#docker%E6%9B%B4%E6%96%B0%E7%BF%BB%E8%BD%A6%E7%8E%B0%E5%9C%BA-mysql\"><span class=\"toc-text\">docker更新翻车现场(mysql)</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA%E6%96%B0%E5%AE%B9%E5%99%A8%EF%BC%8C%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE\"><span class=\"toc-text\">创建新容器，恢复数据</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%80%9A%E8%BF%87ibd%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE\"><span class=\"toc-text\">通过ibd文件恢复数据</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%80%9A%E8%BF%87MYD-MYI-SDI%E6%95%B0%E6%8D%AE%E5%BA%93%E6%81%A2%E5%A4%8D\"><span class=\"toc-text\">通过MYD MYI SDI数据库恢复</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%A1%80%E4%B8%8E%E6%B3%AA%E7%9A%84%E6%95%99%E8%AE%AD\"><span class=\"toc-text\">血与泪的教训</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%A1%A5%E5%85%85%EF%BC%9AInnodb%E4%B8%8EMyISAM%E5%AD%98%E5%82%A8%E6%96%87%E4%BB%B6%E7%9A%84%E5%8C%BA%E5%88%AB\"><span class=\"toc-text\">补充：Innodb与MyISAM存储文件的区别</span></a></li></ol></li></ol>","author":{"name":"小海","slug":"blog-author","avatar":"/avatar/avatar.jpg","link":"/","description":"用一点点代码,改变生活","socials":{"github":"https://github.com/xiaohai-store","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_27873145","juejin":"","customs":{"gitee":{"icon":"/svg/gitee-fill-round.svg","link":"https://gitee.com/wch2020"}}}},"mapped":true,"prev_post":{},"next_post":{"title":"centos下docker无法正常下载新的镜像","uid":"5fe8528ea44b3d1e48a9b1de61cf3137","slug":"centos下docker无法正常下载新的镜像","date":"2023-03-29T05:17:28.000Z","updated":"2023-03-30T03:10:34.087Z","comments":true,"path":"api/articles/centos下docker无法正常下载新的镜像.json","keywords":null,"cover":"../images/docker.jpg","text":"centos下docker无法正常下载新的镜像问题docker无法正常下载镜像，DockerHub上面明明有镜像缺显示not found。最终发现是因为docker版本太旧的问题。导致不支持了 升级docker如果安装的时候使用如下命令，那么恭喜你，你中招了，老老实实升级dock...","link":"","photos":[],"count_time":{"symbolsCount":"1.3k","symbolsTime":"1 mins."},"categories":[{"name":"docker","slug":"docker","count":4,"path":"api/categories/docker.json"}],"tags":[{"name":"docker","slug":"docker","count":4,"path":"api/tags/docker.json"}],"author":{"name":"小海","slug":"blog-author","avatar":"/avatar/avatar.jpg","link":"/","description":"用一点点代码,改变生活","socials":{"github":"https://github.com/xiaohai-store","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_27873145","juejin":"","customs":{"gitee":{"icon":"/svg/gitee-fill-round.svg","link":"https://gitee.com/wch2020"}}}}}}